<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl">
  <title data-ice="title">Home | @dev.smartpricing/verostream</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#config">config</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-WatermarkPrefix">WatermarkPrefix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-WindowMetadataPrefix">WindowMetadataPrefix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RestDefaultConfig">RestDefaultConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CassandraDefaultConfig">CassandraDefaultConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RedisDefaultConfig">RedisDefaultConfig</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#kafka">kafka</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-admin">admin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-client">client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-commit">commit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rekey">rekey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sink">sink</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-source">source</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#loaders">loaders</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-jsonnewline">jsonnewline</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#logger">logger</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-default">default</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#operators">operators</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-filter">filter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-keyBy">keyBy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-print">print</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-withDefaultKey">withDefaultKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-withEventTime">withEventTime</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-withMetadata">withMetadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-customFunction">customFunction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-withSharedEventEmitter">withSharedEventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-toKafka">toKafka</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fromArray">fromArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fromEvent">fromEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fromKafka">fromKafka</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fromSharedEvent">fromSharedEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fromStream">fromStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sessionWindowTime">sessionWindowTime</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tumblingWindowCount">tumblingWindowCount</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tumblingWindowTime">tumblingWindowTime</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#rest">rest</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ExposeStorageState">ExposeStorageState</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#shared">shared</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-eventEmitter">eventEmitter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#storage">storage</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Make">Make</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Make">Make</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Make">Make</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Make">Make</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Make">Make</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Kind">Kind</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#task">task</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-task">task</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#watermark">watermark</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Watermark">Watermark</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#window">window</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MakeWindow">MakeWindow</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><div data-ice="index" class="github-markdown"><h1 id="verostream">VeroStream</h1><h2 id="install">Install</h2><pre><code class="lang-sh"><code class="source-code prettyprint">npm install --save @dev.smartpricing/verostream</code>
</code></pre>
<h2 id="example-usage">Example usage</h2><p>See the dev folder to get more complete (and functional) examples.</p>
<pre><code class="lang-js"><code class="source-code prettyprint">import { 
    Task, 
    StorageKind, 
    KafkaClient, 
    KafkaSource, 
    MakeStorage,
    KafkaSink 
} from &apos;@dev.smartpricing/verostream&apos;

// Setup local kafkajs client
const localClient = KafkaClient({
    clientId: &apos;nsp-test-loc-1&apos;,
    brokers: [&apos;localhost:9092&apos;]  
})

// Set source topic and parsing function
const sourceSessionLog = await KafkaSource(localClient, {
    groupId: &apos;nps-consumer-1&apos;,
    topics: [{
        topic: &apos;t-session-test&apos;, 
        fromBeginning: false
    }]
})

// Process stream
Task()
.setMetadata(&apos;mywinkafka&apos;)
.fromKafka(sourceSessionLog)
.keyBy(mex =&gt; mex.value.pmsId)
.tumblingWindowCount(MakeStorage(StorageKind.Memory), 5)
.each((element) =&gt; {  
    element.value.warnings = element.value.warnings * 10
    return element
})
.reduce((element) =&gt; {
    return element.value.warnings
})
.print()</code>
</code></pre>
<h2 id="doc">Doc</h2><h3 id="kafka">Kafka</h3><p>Wraps directly KafkaJs package.</p>
<pre><code class="lang-js"><code class="source-code prettyprint">import { 
    KafkaClient, 
    KafkaSource, 
    KafkaSink 
} from &apos;@dev.smartpricing/verostream&apos;

// Client, same options as KafkaJs
const client = KafkaClient({
    clientId: &apos;nsp-test-loc-1&apos;,
    brokers: [&apos;localhost:9092&apos;]  
})

// Consumer as source
const source = await KafkaSource(client, {
    groupId: &apos;nps-consumer-1&apos;,
    topics: [{
        topic: &apos;t-session-test&apos;, 
        fromBeginning: false,
        autoCommit: false // Default true 
    }]
})

// Producer as sink
const sink = await KafkaSink(client)

// Rekey
await KafkaRekey(source, s =&gt; s.newKey, sink, (s) =&gt; { return { key: s.key, value: JSON.stringify(s.value)} })</code>
</code></pre>
<h3 id="windows">Windows</h3><p>Embedded inside tasks</p>
<pre><code class="lang-js"><code class="source-code prettyprint">
import { 
    Task,
    StorageKind
} from &apos;@dev.smartpricing/verostream&apos;

Task(). &lt;source&gt; .tumblingWindowTime(MakeStorage(StorageKind.Memory, null, &quot;1&quot;),  1000 * 60 * 5) // 5 minutes window
Task(). &lt;source&gt; .tumblingWindowCount(MakeStorage(StorageKind.Memory, null, &quot;1&quot;), 50) // 50 elements window
Task(). &lt;source&gt; .sessionWindowTime(MakeStorage(StorageKind.Memory, null, &quot;1&quot;), 10 * 1000) // 10 seconds inactivity time
</code>
</code></pre>
<h3 id="operators">Operators</h3><p>Embedded inside tasks</p>
<pre><code class="lang-js"><code class="source-code prettyprint">
// Attach a source stream to a task
Task().fromStream(STREAM_SOURCE)

Task().fromKafka(KAFKA_SOURCE)

Task().fromSharedEvent(EVENT_NAME)

Task().fromEvent(EVENT_EMITTER, EVENT_NAME)

Task().fromArray(ARRAY)

// Emit shared event
Task().emitSharedEvent(EVENT_NAME, DATA)

// Set an ID to a task
Task().setMetadata(ID)

// Split task by item key, must return a string
Task().keyBy(m =&gt; m.myKey)

// Set event time function, must return a valid JS date
// if not setted, the system will use processing time
Task().withEventTime(m =&gt; new Date(m.timestamp))

// Tumbling by window size
Task().tumblingWindowCount(STORAGE, MAX_SIZE)

// Tumbling by window time
Task().tumblingWindowTime(STORAGE, WINDOW_TIME_MILLISECONDS, INACTIVITY_TIME_MILLISECONDS = null)

// Session window
Task().sessionWindowTime(STORAGE, INACTIVITY_TIME_MILLISECONDS)

// Filter message one by one
Task().filter(m =&gt; m.name == &apos;alice&apos;)

// Group by array, returns object with keys/array of grouped elements
Task().groupBy(m =&gt; m.groupByThisValue)

// Manage array items one by one
Task().each()

// Array length
Task().count()

// Flat array of arrays
Task().flat()

// Sum values array for each object key 
Task().sumMap()

// Reduce
Task().reduce(m =&gt; m.warnings)

// Reduce
Task().customFunction((element, trigger) =&gt; {
    // process element
    trigger(element)
})

Task().aggregate(STORAGE, NAME, AGGREGATE_FUNCTION)

// Save data to storage
Task().toStorage(s =&gt; s.key)
// Append to the current processing array data from storage
Task().fromStorage(s =&gt; [(parseInt(s.key) - 1]).toString())

// Print pipeline state
Task().print()</code>
</code></pre>
<h3 id="expose-storage-via-rest">Expose storage via REST</h3><pre><code class="lang-js"><code class="source-code prettyprint">
import { 
    StorageKind,
    MakeStorage,
    ExposeStorageState
} from &apos;@dev.smartpricing/verostream&apos;

ExposeStorageState({&apos;result&apos;: MakeStorage(StorageKind.Redis, null, &apos;result&apos;)})</code>
</code></pre>
<h3 id="kafka-manual-commit">Kafka manual commit</h3><pre><code class="lang-js"><code class="source-code prettyprint">import { 
    KafkaClient,
    KafkaSource,
    KafkaCommit,
    StorageKind,
    MakeStorage
} from &apos;@dev.smartpricing/verostream&apos;

const localClient = KafkaClient({
    clientId: &apos;nsp-test-loc-1&apos;,
    brokers: [&apos;localhost:9092&apos;]  
})

const source = await KafkaSource(localClient, {
    groupId: &apos;nps-consumer-1&apos;,
    topics: [{
        topic: &apos;t-session-test-2&apos;, 
        fromBeginning: false,
        autoCommit: false
    }]
})

Task()
.fromKafka(source)
.customFunction((s, t) =&gt; {
    KafkaCommit(source.consumer(), s)
    t({key: s.key, value: JSON.stringify(s.value)})
})
.print(&quot;&gt;&quot;)</code>
</code></pre>
<h3 id="kafka-sink">Kafka sink</h3><pre><code class="lang-js"><code class="source-code prettyprint">import { 
    KafkaClient,
    KafkaSource,
    KafkaCommit,
    StorageKind,
    MakeStorage
} from &apos;@dev.smartpricing/verostream&apos;

const localClient = KafkaClient({
    clientId: &apos;nsp-test-loc-1&apos;,
    brokers: [&apos;localhost:9092&apos;]  
})

const source = await KafkaSource(localClient, {
    groupId: &apos;nps-consumer-1&apos;,
    topics: [{
        topic: &apos;t-session-test-2&apos;, 
        fromBeginning: false,
        autoCommit: false
    }]
})

let sink = await KafkaSink(localClient)

Task()
.fromKafka(source)
.toKafka(sink, &apos;t-session-test-out&apos;)
.print(&quot;&gt;&quot;)</code>
</code></pre>
<h3 id="available-storages">Available storages</h3><p>Memory, Level, Redis, Cassandra</p>
<p>For Cassandra, you have to manually create the keyspace and the tables on your DB:</p>
<pre><code class="lang-cql"><code class="source-code prettyprint">CREATE KEYSPACE vs WITH replication = {&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos; : 1};

CREATE TABLE vs.storage (
    id text,
    key text,
    value text,
    s_uuid uuid,
    PRIMARY KEY (id, key)
);

CREATE TABLE vs.liststorage (
    id text,
    key text,
    s_uuid uuid,
    value text,
    PRIMARY KEY (id, key, s_uuid)
) WITH CLUSTERING ORDER BY (key asc, s_uuid asc);</code>
</code></pre>
</div>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
